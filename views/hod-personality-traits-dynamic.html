<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Personality Traits Evaluation - E-Appraisal System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .traits-table { font-size: 0.9rem; }
        .traits-table th { background-color: #f8f9fa; font-weight: 600; text-align: center; vertical-align: middle; }
        .traits-table td { vertical-align: middle; }
        .trait-description { font-size: 0.85rem; color: #666; }
        .rating-cell { text-align: center; width: 60px; }
        .score-summary { background-color: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; }
        .junior-staff-badge { background-color: #28a745; }
        .senior-staff-badge { background-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/hod-dashboard.html">
                <i class="fas fa-university me-2"></i>E-Appraisal System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/hod-dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-user-check me-1"></i><span id="navTitle">Personality Traits</span>
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-tie me-1"></i>
                            <span id="userName">Loading...</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><h6 class="dropdown-header">
                                Role: <span id="userRole" class="badge bg-success">HOD</span>
                            </h6></li>
                            <li><h6 class="dropdown-header">
                                Department: <span id="userDepartment">Loading...</span>
                            </h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <div class="container">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="fw-bold text-primary mb-1" id="pageHeader">Personality Traits Evaluation</h2>
                            <p class="text-muted mb-0">Staff: <span id="staffName" class="fw-bold">Loading...</span></p>
                            <p class="text-muted">Category: <span id="staffCategory" class="badge bg-info">Loading...</span></p>
                        </div>
                        <div>
                            <a href="/hod-dashboard.html" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evaluation Form -->
            <form id="personalityTraitsForm">
                <input type="hidden" id="staffId" name="staffId">
                <input type="hidden" id="staffType" name="staffType">

                <!-- Personality Traits Table -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-brain me-2"></i><span id="traitsTitle">Job Evaluation/Personality Traits</span>
                        </h5>
                        <small class="text-muted">Tick appropriate box reflecting your view</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered traits-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40%;">Trait</th>
                                        <th style="width: 8%;">A<br><small>5</small></th>
                                        <th style="width: 8%;">B<br><small>4</small></th>
                                        <th style="width: 8%;">C<br><small>3</small></th>
                                        <th style="width: 8%;">D<br><small>2</small></th>
                                        <th style="width: 8%;">E<br><small>1</small></th>
                                        <th style="width: 20%;">Comments</th>
                                    </tr>
                                </thead>
                                <tbody id="traitsTableBody">
                                    <!-- Traits will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Additional Senior Staff Traits (shown only for senior staff) -->
                <div class="card mb-4" id="additionalTraitsCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user-cog me-2"></i>Additional Senior Staff Personality Traits
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered traits-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40%;">Trait</th>
                                        <th style="width: 8%;">A<br><small>5</small></th>
                                        <th style="width: 8%;">B<br><small>4</small></th>
                                        <th style="width: 8%;">C<br><small>3</small></th>
                                        <th style="width: 8%;">D<br><small>2</small></th>
                                        <th style="width: 8%;">E<br><small>1</small></th>
                                        <th style="width: 20%;">Comments</th>
                                    </tr>
                                </thead>
                                <tbody id="additionalTraitsTableBody">
                                    <!-- Additional traits will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Overall Performance Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Overall Performance Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="score-summary p-3 mb-3">
                                    <h6>Total Score: <span id="totalScore" class="text-primary fw-bold">0</span> / <span id="maxScore">95</span></h6>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%" id="scoreProgress"></div>
                                    </div>
                                    <small class="text-muted mt-2 d-block">Performance Rating: <span id="performanceRating" class="fw-bold">Not Calculated</span></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="overallComments" class="form-label">Overall Comments</label>
                                    <textarea class="form-control" id="overallComments" name="overallComments" rows="4" placeholder="Provide overall assessment comments..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submission Section -->
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="text-primary mb-3" id="submitTitle">Submit Evaluation</h5>
                        <p class="text-muted mb-4">Please review all ratings before submitting the personality traits evaluation.</p>
                        
                        <div class="d-flex gap-3 justify-content-center">
                            <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Submit Evaluation
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script>
        // Common personality traits data
        const personalityTraits = [
            { id: 'conduct', name: 'CONDUCT between exceedingly well', description: 'Always exhibits bad behaviour' },
            { id: 'relationship', name: 'RELATIONSHIP WITH COLLEAGUES', description: 'Sensitive to other people\'s feelings, gains respect of others, exceptionally effective in working with members of the public and colleagues' },
            { id: 'responsibility', name: 'LEVEL OF RESPONSIBILITY', description: 'Demonstrates excellent ability to take responsibility' },
            { id: 'quality_work', name: 'QUALITY OF WORK', description: 'Work is always very neat and full of errors' },
            { id: 'quality_output', name: 'QUALITY OF OUTPUT', description: 'Produces a lot within specified time' },
            { id: 'initiative', name: 'INITIATIVE', description: 'Demonstrates ability to solve basic problems with minimum supervision' },
            { id: 'adaptability', name: 'ADAPTABILITY', description: 'Easily adjusts to the environment of work and compliant' },
            { id: 'expression_paper', name: 'EXPRESSION ON PAPER', description: 'Always concise and clear' },
            { id: 'oral_expression', name: 'ORAL EXPRESSION', description: 'Expresses himself consistently, articulately and at all levels' },
            { id: 'regularity', name: 'REGULARITY', description: 'Always regular' },
            { id: 'management_resources', name: 'MANAGEMENT OF RESOURCES', description: 'Uses resources effectively' },
            { id: 'organisation_work', name: 'ORGANISATION OF WORK', description: 'Plans and organises work effectively' },
            { id: 'self_improvement', name: 'SELF IMPROVEMENT EFFORT', description: 'Makes conscious effort for improvement' },
            { id: 'attitude_work', name: 'ATTITUDE TO WORK', description: 'Always willing to work, demonstrates without supervision' },
            { id: 'reliability', name: 'DEGREE OF RELIABILITY', description: 'Highly dependable' },
            { id: 'knowledge_rules', name: 'KNOWLEDGE OF DEPARTMENTAL RULES', description: 'Highly knowledgeable and acquainted with procedures' },
            { id: 'punctuality', name: 'PUNCTUALITY', description: 'Always punctual' },
            { id: 'integrity', name: 'INTEGRITY', description: 'Impeccable character' },
            { id: 'neatness', name: 'NEATNESS', description: 'Always untidy' }
        ];

        // Additional traits for senior staff
        const additionalTraits = [
            { id: 'foresight', name: 'Foresight', description: 'Anticipates problems and develops solutions in advance' },
            { id: 'judgement', name: 'Judgement', description: 'Analyses situations and makes sound decisions' },
            { id: 'command_language', name: 'Command of Language', description: 'Puts his points across convincingly and correctly' },
            { id: 'human_relations', name: 'Human Relations', description: 'Sensitive to people\'s feelings, tactful and considerate' },
            { id: 'sense_responsibility', name: 'Sense of Responsibility', description: 'Seeks and accepts responsibility at all times' },
            { id: 'leadership_qualities', name: 'Leadership Qualities', description: 'Organises and inspires staff effectively' },
            { id: 'level_efficiency', name: 'Level of Efficiency', description: 'Gets a great deal done within a set time' },
            { id: 'punctuality_senior', name: 'Punctuality', description: 'Always punctual' },
            { id: 'regularity_senior', name: 'Regularity', description: 'Highly regular in the performance of duties' },
            { id: 'technical_knowledge', name: 'Technical Knowledge', description: 'Has good grasp of professional/technical knowledge' }
        ];

        let currentStaffType = 'junior'; // Default to junior

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            initializePageBasedOnStaffType();
            loadUserInfo();
            loadStaffInfo();
            populateTraitsTable();
            setupFormHandlers();
        });

        function initializePageBasedOnStaffType() {
            const urlParams = new URLSearchParams(window.location.search);
            const staffType = urlParams.get('staffType') || 'junior';
            currentStaffType = staffType;

            // Update page elements based on staff type
            if (staffType === 'senior') {
                document.getElementById('pageTitle').textContent = 'Senior Staff Personality Traits Evaluation - E-Appraisal System';
                document.getElementById('pageHeader').textContent = 'Senior Staff Personality Traits Evaluation';
                document.getElementById('navTitle').textContent = 'Senior Staff Personality Traits';
                document.getElementById('traitsTitle').textContent = 'Job Evaluation/Personality Traits (Senior Staff)';
                document.getElementById('submitTitle').textContent = 'Submit Senior Staff Evaluation';
                document.getElementById('staffType').value = 'senior';
                document.getElementById('overallComments').placeholder = 'Provide overall assessment comments for senior staff...';
                
                // Show additional traits section
                document.getElementById('additionalTraitsCard').style.display = 'block';
                populateAdditionalTraitsTable();
            } else {
                document.getElementById('pageTitle').textContent = 'Junior Staff Personality Traits Evaluation - E-Appraisal System';
                document.getElementById('pageHeader').textContent = 'Junior Staff Personality Traits Evaluation';
                document.getElementById('navTitle').textContent = 'Junior Staff Personality Traits';
                document.getElementById('traitsTitle').textContent = 'Job Evaluation/Personality Traits (Junior Staff)';
                document.getElementById('submitTitle').textContent = 'Submit Junior Staff Evaluation';
                document.getElementById('staffType').value = 'junior';
                document.getElementById('overallComments').placeholder = 'Provide overall assessment comments for junior staff...';
            }
        }

        function populateTraitsTable() {
            const tbody = document.getElementById('traitsTableBody');
            tbody.innerHTML = '';

            personalityTraits.forEach((trait, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>(${String.fromCharCode(97 + index)}) ${trait.name}:</strong>
                        <div class="trait-description">${trait.description}</div>
                    </td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="5" class="form-check-input" onchange="calculateScore()"></td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="4" class="form-check-input" onchange="calculateScore()"></td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="3" class="form-check-input" onchange="calculateScore()"></td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="2" class="form-check-input" onchange="calculateScore()"></td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="1" class="form-check-input" onchange="calculateScore()"></td>
                    <td><input type="text" class="form-control form-control-sm" name="${trait.id}_comment" placeholder="Comments"></td>
                `;
                tbody.appendChild(row);
            });
        }

        function populateAdditionalTraitsTable() {
            const tbody = document.getElementById('additionalTraitsTableBody');
            tbody.innerHTML = '';

            additionalTraits.forEach((trait, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>(${String.fromCharCode(116 + index)}) ${trait.name}:</strong>
                        <div class="trait-description">${trait.description}</div>
                    </td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="5" class="form-check-input" onchange="calculateScore()"></td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="4" class="form-check-input" onchange="calculateScore()"></td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="3" class="form-check-input" onchange="calculateScore()"></td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="2" class="form-check-input" onchange="calculateScore()"></td>
                    <td class="rating-cell"><input type="radio" name="${trait.id}" value="1" class="form-check-input" onchange="calculateScore()"></td>
                    <td><input type="text" class="form-control form-control-sm" name="${trait.id}_comment" placeholder="Comments"></td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculateScore() {
            let totalScore = 0;
            let allTraits = [...personalityTraits];
            
            if (currentStaffType === 'senior') {
                allTraits = [...personalityTraits, ...additionalTraits];
            }
            
            const maxScore = allTraits.length * 5;

            allTraits.forEach(trait => {
                const selectedRating = document.querySelector(`input[name="${trait.id}"]:checked`);
                if (selectedRating) {
                    totalScore += parseInt(selectedRating.value);
                }
            });

            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('maxScore').textContent = maxScore;
            
            const percentage = (totalScore / maxScore) * 100;
            document.getElementById('scoreProgress').style.width = percentage + '%';

            // Update performance rating
            let rating = 'Unsatisfactory';
            if (percentage >= 80) rating = 'Outstanding';
            else if (percentage >= 70) rating = 'Very Good';
            else if (percentage >= 60) rating = 'Good';
            else if (percentage >= 50) rating = 'Fair';

            document.getElementById('performanceRating').textContent = rating;
        }

        function setupFormHandlers() {
            const form = document.getElementById('personalityTraitsForm');
            if (!form) {
                console.error('Form not found: personalityTraitsForm');
                return;
            }
            
            console.log('Setting up form handlers for personality traits form');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submission triggered');
                
                // Validate form before submission
                if (!validateForm()) {
                    console.log('Form validation failed');
                    return;
                }
                
                console.log('Form validation passed, submitting evaluation');
                
                // Check if submitEvaluation function exists
                if (typeof submitEvaluation === 'function') {
                    submitEvaluation();
                } else {
                    console.error('submitEvaluation function not found');
                    showAlert('Error: Submit function not available. Please refresh the page and try again.', 'danger');
                }
            });
            
            // Add direct click event listener as fallback
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    console.log('Submit button clicked directly');
                    // Let the form submit event handle it
                });
            }
        }

        function validateForm() {
            console.log('Validating form...');
            
            // Check if at least one trait is rated
            const ratingInputs = document.querySelectorAll('input[type="radio"]:checked');
            console.log('Number of rated traits:', ratingInputs.length);
            
            if (ratingInputs.length === 0) {
                showAlert('Please rate at least one personality trait before submitting.', 'danger');
                return false;
            }
            
            // Check if overall comments are provided
            const comments = document.getElementById('overallComments').value.trim();
            console.log('Overall comments length:', comments.length);
            
            if (!comments) {
                showAlert('Please provide overall comments before submitting.', 'danger');
                return false;
            }
            
            console.log('Form validation successful');
            return true;
        }

        async function submitEvaluation() {
            console.log('Starting evaluation submission...');
            
            const form = document.getElementById('personalityTraitsForm');
            const formData = new FormData(form);
            
            const staffId = formData.get('staffId');
            const staffType = formData.get('staffType');
            const overallComments = formData.get('overallComments');
            
            console.log('Form data:', { staffId, staffType, overallComments });
            
            if (!staffId || !staffType || !overallComments) {
                showAlert('Missing required information. Please ensure all fields are filled.', 'danger');
                return;
            }
            
            const payload = {
                staffId: staffId,
                staffType: staffType,
                overallComments: overallComments,
                traits: {}
            };

            let allTraits = [...personalityTraits];
            if (currentStaffType === 'senior') {
                allTraits.push(...additionalTraits);
            }

            allTraits.forEach(trait => {
                const rating = formData.get(trait.id);
                const comment = formData.get(`${trait.id}_comment`);
                if (rating) {
                    payload.traits[trait.id] = {
                        rating: parseInt(rating, 10),
                        comment: comment || ''
                    };
                }
            });
            
            console.log('Collected traits data:', payload.traits);

            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/hod/personality-traits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);

                const contentType = response.headers.get('content-type') || '';
                let responseBody;

                if (contentType.includes('application/json')) {
                    responseBody = await response.json();
                } else {
                    const rawText = await response.text();
                    console.warn('Unexpected non-JSON response:', rawText);
                    throw new Error('Unexpected server response. Please try again or contact support.');
                }

                console.log('Response data:', responseBody);

                if (!response.ok || !responseBody.success) {
                    const message = responseBody && responseBody.message ? responseBody.message : 'Error submitting evaluation.';
                    showAlert(message, 'danger');
                    return;
                }

                const staffTypeText = currentStaffType === 'senior' ? 'Senior staff' : 'Junior staff';
                showAlert(`${staffTypeText} personality traits evaluation submitted successfully!`, 'success');
                checkAppraisalStatusAndRedirect(staffId);
            } catch (error) {
                console.error('Submission error:', error);
                showAlert(error.message || 'Error submitting evaluation. Please try again.', 'danger');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function checkAppraisalStatusAndRedirect(staffId) {
            try {
                // For now, just redirect to dashboard after successful submission
                // This can be enhanced later to check actual appraisal status
                setTimeout(() => {
                    window.location.href = '/hod-dashboard.html';
                }, 2000);
            } catch (error) {
                console.error('Error in redirect function:', error);
                setTimeout(() => {
                    window.location.href = '/hod-dashboard.html';
                }, 2000);
            }
        }

        // Add showAlert function if it's not available from main.js
        function showAlert(message, type = 'success') {
            console.log('Showing alert:', message, type);
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container') || document.body;
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Add loadUserInfo function if it's not available from main.js
        async function loadUserInfo() {
            console.log('Loading user info...');
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const user = await response.json();
                    console.log('User info loaded:', user);
                    
                    const userNameEl = document.getElementById('userName');
                    const userDepartmentEl = document.getElementById('userDepartment');
                    
                    if (userNameEl) userNameEl.textContent = user.name;
                    if (userDepartmentEl) userDepartmentEl.textContent = user.department;
                } else {
                    console.error('Failed to load user info:', response.status);
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Add logout function if it's not available from main.js
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                });
                
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Make logout function globally available
        window.logout = logout;

        function loadStaffInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            const staffId = urlParams.get('staffId');
            
            if (staffId) {
                document.getElementById('staffId').value = staffId;
                // Load staff details
                fetch(`/api/staff/${staffId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('staffName').textContent = data.staff.name;
                            
                            // Update staff category badge
                            const categoryBadge = document.getElementById('staffCategory');
                            if (currentStaffType === 'senior') {
                                categoryBadge.textContent = 'Senior Staff';
                                categoryBadge.className = 'badge senior-staff-badge';
                            } else {
                                categoryBadge.textContent = 'Junior Staff';
                                categoryBadge.className = 'badge junior-staff-badge';
                            }
                        }
                    })
                    .catch(error => console.error('Error loading staff info:', error));
            }
        }
    </script>
</body>
</html>
